<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prediction Market</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 2.5rem; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 400px; text-align: center; }
        
        h1 { margin: 0 0 10px 0; font-size: 1.8rem; color: #1a1a1a; }
        .question { color: #65676b; margin-bottom: 2rem; }

        /* Price Bars */
        .bars { display: flex; height: 50px; border-radius: 8px; overflow: hidden; margin-bottom: 25px; font-weight: bold; color: white; cursor: default; }
        .bar-yes { background: #34c759; display: flex; align-items: center; justify-content: center; transition: all 0.5s ease; }
        .bar-no { background: #ff3b30; display: flex; align-items: center; justify-content: center; transition: all 0.5s ease; }

        /* Inputs */
        .input-group { margin-bottom: 15px; text-align: left; }
        label { display: block; font-size: 0.8rem; color: #65676b; margin-bottom: 5px; font-weight: 600; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; width: 100%; box-sizing: border-box; font-size: 1rem; outline: none; transition: border 0.2s; }
        input:focus { border-color: #007aff; }

        /* Buttons */
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        button { padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: transform 0.1s, opacity 0.2s; color: white; font-size: 1rem; }
        button:active { transform: scale(0.98); }
        .btn-yes { background: #34c759; }
        .btn-no { background: #ff3b30; }

        .log { margin-top: 20px; font-size: 0.9rem; color: #555; min-height: 20px; }
        
        .admin-link { display: block; margin-top: 30px; color: #007aff; text-decoration: none; font-size: 0.9rem; }
        .admin-link:hover { text-decoration: underline; }
    </style>
</head>
<body>

<div class="card">
    <h1>Will it rain tomorrow?</h1>
    <p class="question">Market Odds (AMM)</p>

    <div class="bars">
        <div id="bar-yes" class="bar-yes" style="width: 50%">50¢</div>
        <div id="bar-no" class="bar-no" style="width: 50%">50¢</div>
    </div>

    <div class="input-group">
        <label>Your Email Address</label>
        <input type="email" id="email" placeholder="name@example.com">
    </div>

    <div class="input-group">
        <label>Number of Shares</label>
        <input type="number" id="qty" value="10" min="1">
    </div>

    <div class="controls">
        <button class="btn-yes" onclick="buy('YES')">Buy YES</button>
        <button class="btn-no" onclick="buy('NO')">Buy NO</button>
    </div>

    <div class="log" id="log"></div>

    <a href="/download_trades" class="admin-link">⬇ Download Trade Report (CSV)</a>
</div>

<script>
    async function updateState() {
        const res = await fetch('/api/state');
        const data = await res.json();
        
        const yesPct = (data.price_yes * 100).toFixed(1);
        const noPct = (data.price_no * 100).toFixed(1);
        
        const barYes = document.getElementById('bar-yes');
        const barNo = document.getElementById('bar-no');

        barYes.style.width = yesPct + "%";
        barYes.innerText = Math.round(data.price_yes * 100) + "¢";
        
        barNo.style.width = noPct + "%";
        barNo.innerText = Math.round(data.price_no * 100) + "¢";
    }

    async function buy(outcome) {
        const email = document.getElementById('email').value;
        const qty = document.getElementById('qty').value;
        const log = document.getElementById('log');

        if (!email) {
            log.style.color = 'red';
            log.innerText = "Please enter your email first!";
            return;
        }

        log.style.color = '#555';
        log.innerText = "Processing...";

        const res = await fetch('/api/buy', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email, outcome, qty })
        });
        
        const data = await res.json();
        
        if (data.error) {
            log.style.color = 'red';
            log.innerText = data.error;
        } else {
            log.style.color = 'green';
            log.innerText = `Success! You paid $${data.cost.toFixed(2)}`;
            updateState();
        }
    }

    updateState();
    setInterval(updateState, 3000);
</script>

</body>
</html>